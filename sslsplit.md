### sslsplit

Based on https://blog.heckel.xyz/2013/08/04/use-sslsplit-to-transparently-sniff-tls-ssl-connections/

### Installing sslsplit

Debian now has packages for sslsplit, so just do

```
sudo apt-get install sslsplit
```

### Generate the certificate

If you have installed mitmproxy, you can use the certs generated by mitmproxy. Otherwise, generate the CA key and certificate by running the following commands:

```
openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 1826 -key ca.key -out ca.cer
```

Save the certificate on to your device.

### Setup iptables

If one has been following the mitmproxy installation instructions, ip forwarding will have been setup (and is persistant). Otherwise run

```
sysctl -w net.ipv4.ip_forward=1
sudo sysctl -w net.ipv4.conf.all.send_redirects=0
```

Then setup iptables such that sslsplit will listen on port 8080 for TCP+non-SSL connections and port 8443 for TCP+SSL connections (the second and third lines are required for the raspi to work as an access point)

```
sudo iptables -F
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-ports 8080
sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 443 -j REDIRECT --to-ports 8443
sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 587 -j REDIRECT --to-ports 8443
sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 465 -j REDIRECT --to-ports 8443
sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 993 -j REDIRECT --to-ports 8443
sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 5222 -j REDIRECT --to-ports 8080
```

### Running sslsplit

If you have installed mitmproxy:

```
sudo sslsplit -D -l connections.log -j ~/sslconn/ -S ~/ssllog/ -c ~/.mitmproxy/mitmproxy-ca-cert.pem -k ~/.mitmproxy/mitmproxy-ca.pem ssl 0.0.0.0 8443 tcp 0.0.0.0 8080
```

Otherwise:

```
sudo sslsplit -D -l connections.log -j ./<directory where connection details go>/ -S ./<directory where logs go>/ -k ca.key -c ca.cer ssl 0.0.0.0 8443 tcp 0.0.0.0 8080
```

e.g.

```
sudo sslsplit -D -l connections.log -j ./sslconn/ -S ./ssllog/ -k ca.key -c ca.cer ssl 0.0.0.0 8443 tcp 0.0.0.0 8080
```

### sslsplit 0.5.4
sslsplit 0.5.4 enables capturing pcap files and saving the premaster secret into a file (needed to decrypt the packets in the pcap file).

To install,
```
sudo apt-get install libevent-dev libpcap-dev libnet1-dev

wget https://mirror.roe.ch/rel/sslsplit/sslsplit-0.5.4.tar.bz2
bunzip2 sslsplit-0.5.4.tar.bz2  
tar xvf sslsplit-0.5.4.tar  
cd sslsplit-0.5.4
make install
```

An example command that you can run, `-X` being the pcap output file and `-M` being the ssl key log file for the premaster secret. This command uses the mitmproxy cert (`mitmproxy-ca.pem` contains both the key and the certificate according to https://docs.mitmproxy.org/stable/concepts-certificates/#ca-and-cert-files)
```
sudo sslsplit -D -l connections.log -c ~/.mitmproxy/mitmproxy-ca.pem -k ~/.mitmproxy/mitmproxy-ca.pem -X sslsplit.pcap -M sslkeylogfile ssl 0.0.0.0 8443 tcp 0.0.0.0 8080
```
